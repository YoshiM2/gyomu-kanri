<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>æ¥­å‹™å®Ÿç¸¾ç®¡ç†ã‚¢ãƒ—ãƒª v4</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --primary:#00B900;--primary-dark:#007a00;--primary-light:#e8fae8;
  --accent:#005bac;--text:#1a1a2e;--text-light:#6b7280;
  --bg:#f0f4f8;--card:#fff;--border:#e2e8f0;
  --danger:#ef4444;--warning:#f59e0b;--shadow:0 4px 24px rgba(0,0,0,.08);
  --locked:#94a3b8;--admin:#7c3aed;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.header{background:linear-gradient(135deg,#00B900,#00d400);color:white;position:sticky;top:0;z-index:200;box-shadow:0 2px 12px rgba(0,185,0,.3);}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;}
.header-title{font-size:16px;font-weight:700;}
.header-sub{font-size:10px;opacity:.8;}
.user-area{display:flex;align-items:center;gap:8px;}
.user-badge{background:rgba(255,255,255,.2);border-radius:20px;padding:6px 12px;font-size:12px;font-weight:500;}
.admin-btn{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.4);border-radius:20px;padding:5px 10px;font-size:11px;color:white;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .2s;}
.admin-btn.active-admin{background:#7c3aed;border-color:#7c3aed;}
.nav-tabs{display:flex;background:white;border-bottom:2px solid var(--border);overflow-x:auto;scrollbar-width:none;}
.nav-tabs::-webkit-scrollbar{display:none;}
.nav-tab{flex:1;padding:11px 3px;font-size:11px;font-weight:500;color:var(--text-light);border:none;background:none;cursor:pointer;border-bottom:3px solid transparent;white-space:nowrap;min-width:48px;font-family:'Noto Sans JP',sans-serif;}
.nav-tab.active{color:var(--primary);border-bottom-color:var(--primary);}
.nav-tab.admin-tab{color:var(--admin);}
.nav-tab.admin-tab.active{border-bottom-color:var(--admin);}

/* â”€â”€â”€ SCREENS â”€â”€â”€ */
.screen{display:none;padding:14px;animation:fadeIn .25s ease;}
.screen.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€â”€ CARD â”€â”€â”€ */
.card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:var(--shadow);border:1px solid var(--border);}
.card-title{font-size:11px;font-weight:700;color:var(--text-light);text-transform:uppercase;letter-spacing:.8px;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.card-title::before{content:'';width:3px;height:13px;background:var(--primary);border-radius:2px;flex-shrink:0;}
.card-title.admin::before{background:var(--admin);}

/* â”€â”€â”€ STEP â”€â”€â”€ */
.step-indicator{display:flex;align-items:center;justify-content:center;gap:4px;margin-bottom:14px;}
.step-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:all .3s;}
.step-dot.active{background:var(--primary);width:24px;border-radius:4px;}
.step-dot.done{background:var(--primary);opacity:.5;}
.step-title{font-size:17px;font-weight:700;margin-bottom:5px;}
.step-sub{font-size:13px;color:var(--text-light);margin-bottom:14px;line-height:1.6;}

/* â”€â”€â”€ æ™‚é–“å¸¯ãƒ©ã‚¸ã‚ªï¼ˆå¤§ãƒœã‚¿ãƒ³ï¼‰â”€â”€â”€ */
.hour-grid{display:grid;gap:8px;margin-bottom:14px;}
.hour-grid.col2{grid-template-columns:1fr 1fr;}
.hour-grid.col3{grid-template-columns:1fr 1fr 1fr;}
.hour-item{position:relative;}
.hour-item input[type=radio],.hour-item input[type=checkbox]{position:absolute;opacity:0;width:0;height:0;}
.hour-label{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  border:2px solid var(--border);border-radius:12px;
  padding:14px 8px;cursor:pointer;transition:all .2s;background:white;
  text-align:center;min-height:64px;gap:2px;
}
.hour-label .hl-main{font-size:15px;font-weight:700;color:var(--text);}
.hour-label .hl-sub{font-size:11px;color:var(--text-light);}
.hour-item input[type=radio]:checked + .hour-label,
.hour-item input[type=checkbox]:checked + .hour-label{
  border-color:var(--primary);background:var(--primary-light);
}
.hour-item input[type=radio]:checked + .hour-label .hl-main,
.hour-item input[type=checkbox]:checked + .hour-label .hl-main{color:var(--primary-dark);}
.hour-label:hover{border-color:var(--primary);background:var(--primary-light);}
.hour-label.is-default{border-color:#93c5fd;background:#eff6ff;}
.hour-item input[type=radio]:checked + .hour-label.is-default{border-color:var(--primary);background:var(--primary-light);}

/* â”€â”€â”€ CHOICE BTNS â”€â”€â”€ */
.choice-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.choice-grid.single{grid-template-columns:1fr;}
.choice-btn{background:white;border:2px solid var(--border);border-radius:12px;padding:14px 10px;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;font-family:'Noto Sans JP',sans-serif;color:var(--text);line-height:1.4;}
.choice-btn:hover{border-color:var(--primary);background:var(--primary-light);}
.choice-btn.selected{border-color:var(--primary);background:var(--primary-light);color:var(--primary-dark);font-weight:700;}
.choice-btn .emoji{font-size:20px;display:block;margin-bottom:5px;}
.choice-btn:disabled{opacity:.4;cursor:not-allowed;}

/* â”€â”€â”€ FEATURE RADIO â”€â”€â”€ */
.feature-radio-list{display:flex;flex-direction:column;gap:8px;margin-bottom:14px;}
.feature-radio-item{position:relative;}
.feature-radio-item input[type=radio]{position:absolute;opacity:0;width:0;height:0;}
.feature-radio-label{display:flex;align-items:center;gap:12px;border:2px solid var(--border);border-radius:12px;padding:12px 14px;cursor:pointer;transition:all .2s;background:white;}
.feature-radio-item input[type=radio]:checked + .feature-radio-label{border-color:var(--primary);background:var(--primary-light);}
.feature-radio-label:hover{border-color:var(--primary);background:var(--primary-light);}
.fr-dot{width:18px;height:18px;border-radius:50%;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.feature-radio-item input[type=radio]:checked + .feature-radio-label .fr-dot{border-color:var(--primary);background:var(--primary);}
.feature-radio-item input[type=radio]:checked + .feature-radio-label .fr-dot::after{content:'';width:7px;height:7px;background:white;border-radius:50%;}
.fr-info{flex:1;}
.fr-name{font-size:13px;font-weight:600;}
.fr-meta{font-size:11px;color:var(--text-light);margin-top:2px;}
.fr-bar{height:4px;background:var(--border);border-radius:2px;margin-top:4px;overflow:hidden;}
.fr-bar-fill{height:100%;border-radius:2px;background:var(--primary);}
.fr-badge{font-size:10px;padding:2px 7px;border-radius:10px;background:var(--primary-light);color:var(--primary-dark);font-weight:700;flex-shrink:0;}

/* â”€â”€â”€ SLIDER â”€â”€â”€ */
.progress-section{margin-bottom:14px;}
.progress-label{display:flex;justify-content:space-between;margin-bottom:8px;font-size:13px;}
.progress-value{font-weight:700;color:var(--primary);font-size:17px;}
input[type=range]{width:100%;height:6px;border-radius:3px;appearance:none;outline:none;cursor:pointer;}
input[type=range]::-webkit-slider-thumb{appearance:none;width:22px;height:22px;border-radius:50%;background:var(--primary);box-shadow:0 2px 8px rgba(0,185,0,.4);cursor:pointer;}

/* â”€â”€â”€ DATE â”€â”€â”€ */
.date-row{display:flex;gap:8px;align-items:center;margin-bottom:14px;}
.date-input{flex:1;border:2px solid var(--border);border-radius:10px;padding:11px 14px;font-size:14px;font-family:'Noto Sans JP',sans-serif;outline:none;transition:border-color .2s;color:var(--text);background:white;}
.date-input:focus{border-color:var(--primary);}
.locked-badge{background:#fef2f2;border:1px solid #fecaca;border-radius:8px;padding:8px 12px;font-size:12px;color:var(--danger);display:flex;align-items:center;gap:6px;margin-bottom:12px;}

/* â”€â”€â”€ INPUTS â”€â”€â”€ */
.text-input{width:100%;border:2px solid var(--border);border-radius:10px;padding:11px 14px;font-size:13px;font-family:'Noto Sans JP',sans-serif;outline:none;transition:border-color .2s;resize:none;color:var(--text);background:white;}
.text-input:focus{border-color:var(--primary);}
.select-input{width:100%;border:2px solid var(--border);border-radius:10px;padding:11px 14px;font-size:13px;font-family:'Noto Sans JP',sans-serif;outline:none;appearance:none;background:white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%236b7280' fill='none' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 14px center;cursor:pointer;color:var(--text);}
.select-input:focus{border-color:var(--primary);}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn-primary{width:100%;background:linear-gradient(135deg,var(--primary),#00c400);color:white;border:none;border-radius:12px;padding:14px;font-size:15px;font-weight:700;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .2s;box-shadow:0 4px 16px rgba(0,185,0,.3);}
.btn-primary:hover{transform:translateY(-2px);}
.btn-secondary{background:white;color:var(--text-light);border:2px solid var(--border);border-radius:10px;padding:11px;font-size:13px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;transition:all .2s;width:100%;margin-bottom:8px;}
.btn-small{padding:6px 12px;border-radius:8px;font-size:12px;font-family:'Noto Sans JP',sans-serif;cursor:pointer;border:1px solid var(--border);background:white;color:var(--text);}
.btn-small.primary{background:var(--primary);color:white;border-color:var(--primary);}
.btn-small.danger{background:#fef2f2;color:var(--danger);border-color:#fecaca;}
.btn-small.purple{background:#f5f3ff;color:var(--admin);border-color:#ddd6fe;}
.btn-small.teal{background:#f0fdfa;color:#0f766e;border-color:#99f6e4;}

/* â”€â”€â”€ SUMMARY â”€â”€â”€ */
.summary-item{display:flex;justify-content:space-between;align-items:flex-start;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px;}
.summary-item:last-child{border-bottom:none;}
.summary-label{color:var(--text-light);flex-shrink:0;padding-right:10px;}
.summary-value{font-weight:600;text-align:right;word-break:break-all;}

/* â”€â”€â”€ STATS â”€â”€â”€ */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.stat-card{background:white;border-radius:12px;padding:14px;text-align:center;border:1px solid var(--border);box-shadow:var(--shadow);}
.stat-number{font-size:26px;font-weight:700;color:var(--primary);display:block;font-family:'Inter',sans-serif;}
.stat-label{font-size:11px;color:var(--text-light);margin-top:4px;}

/* â”€â”€â”€ BAR â”€â”€â”€ */
.bar-chart{margin-top:6px;}
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:10px;}
.bar-name{font-size:12px;width:80px;flex-shrink:0;color:var(--text-light);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bar-track{flex:1;height:10px;background:var(--border);border-radius:5px;overflow:hidden;}
.bar-fill{height:100%;border-radius:5px;}
.bar-val{font-size:12px;width:36px;text-align:right;font-weight:600;font-family:'Inter',sans-serif;}

/* â”€â”€â”€ WEEK TABLE â”€â”€â”€ */
.week-table{width:100%;border-collapse:collapse;font-size:12px;}
.week-table th{background:#f8fafc;padding:8px 5px;text-align:center;border:1px solid var(--border);font-weight:600;color:var(--text-light);}
.week-table td{padding:7px 5px;text-align:center;border:1px solid var(--border);}
.week-table tr:hover td{background:#f8fafc;}
.prog-mini{height:5px;border-radius:3px;background:var(--border);overflow:hidden;margin-top:3px;}
.prog-mini-fill{height:100%;border-radius:3px;}

/* â”€â”€â”€ AGGREGATE TABLE â”€â”€â”€ */
.aggr-table{width:100%;border-collapse:collapse;font-size:12px;}
.aggr-table th{background:#f1f5f9;padding:9px 8px;text-align:left;border:1px solid var(--border);font-weight:700;font-size:11px;white-space:nowrap;position:sticky;top:0;}
.aggr-table td{padding:8px;border:1px solid var(--border);vertical-align:top;white-space:nowrap;}
.aggr-table tr:hover td{background:#f8fafc;}
.aggr-table tr:nth-child(even) td{background:#fafbfc;}
.aggr-table tr:nth-child(even):hover td{background:#f0f9f0;}
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.filter-select{border:1.5px solid var(--border);border-radius:8px;padding:7px 12px;font-size:12px;font-family:'Noto Sans JP',sans-serif;outline:none;background:white;color:var(--text);cursor:pointer;}
.filter-select:focus{border-color:var(--primary);}
.filter-input{border:1.5px solid var(--border);border-radius:8px;padding:7px 12px;font-size:12px;font-family:'Noto Sans JP',sans-serif;outline:none;background:white;color:var(--text);}
.filter-input:focus{border-color:var(--primary);}

/* â”€â”€â”€ TIMELINE â”€â”€â”€ */
.timeline{list-style:none;}
.timeline-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);}
.timeline-item:last-child{border-bottom:none;}
.tl-dot{width:10px;height:10px;border-radius:50%;background:var(--primary);margin-top:3px;flex-shrink:0;}
.tl-content{flex:1;}
.tl-name{font-size:13px;font-weight:600;}
.tl-detail{font-size:12px;color:var(--text-light);margin-top:2px;}
.tl-time{font-size:11px;color:var(--text-light);flex-shrink:0;}

/* â”€â”€â”€ BADGE â”€â”€â”€ */
.badge{display:inline-block;padding:2px 7px;border-radius:20px;font-size:11px;font-weight:600;margin-left:4px;}
.badge-green{background:var(--primary-light);color:var(--primary-dark);}
.badge-blue{background:#dbeafe;color:var(--accent);}
.badge-orange{background:#fef3c7;color:#b45309;}

/* â”€â”€â”€ DONUT â”€â”€â”€ */
.donut-wrap{display:flex;align-items:center;gap:16px;}
.donut-legend{flex:1;}
.legend-item{display:flex;align-items:center;gap:8px;margin-bottom:8px;font-size:13px;}
.legend-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}

/* â”€â”€â”€ TOGGLE â”€â”€â”€ */
.toggle-wrap{position:relative;display:inline-block;width:44px;height:24px;}
.toggle-wrap input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;border-radius:24px;background:#ccc;transition:.3s;}
.toggle-slider::before{position:absolute;content:'';height:18px;width:18px;left:3px;bottom:3px;background:white;border-radius:50%;transition:.3s;}
.toggle-wrap input:checked + .toggle-slider{background:var(--primary);}
.toggle-wrap input:checked + .toggle-slider::before{transform:translateX(20px);}

/* â”€â”€â”€ UPLOAD â”€â”€â”€ */
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:22px;text-align:center;cursor:pointer;transition:all .2s;background:#fafbfc;}
.upload-zone:hover,.upload-zone.drag-over{border-color:var(--primary);background:var(--primary-light);}

/* â”€â”€â”€ PLAN TABLE â”€â”€â”€ */
.plan-table{width:100%;border-collapse:collapse;font-size:12px;}
.plan-table th{background:#f1f5f9;padding:9px 7px;text-align:left;border:1px solid var(--border);font-weight:700;font-size:11px;white-space:nowrap;}
.plan-table td{padding:7px;border:1px solid var(--border);vertical-align:top;}
.plan-table tr:hover td{background:#f8fafc;}
.plan-table input,.plan-table select{border:1px solid transparent;border-radius:5px;padding:4px 6px;font-size:12px;font-family:'Noto Sans JP',sans-serif;width:100%;background:transparent;color:var(--text);}
.plan-table input:focus,.plan-table select:focus{outline:none;border-color:var(--primary);background:white;}

/* â”€â”€â”€ CALENDAR â”€â”€â”€ */
.cal-header-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:3px;text-align:center;font-size:11px;font-weight:700;color:var(--text-light);}
.holiday-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-day{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:500;cursor:pointer;border:1px solid transparent;}
.cal-day.weekday{background:#f8fafc;color:var(--text);}
.cal-day.weekend{background:#fef2f2;color:var(--danger);}
.cal-day.holiday-nat{background:#fee2e2;color:var(--danger);font-weight:700;}
.cal-day.work-override{background:var(--primary-light);color:var(--primary-dark);font-weight:700;border-color:var(--primary);}
.cal-day.today-cal{box-shadow:0 0 0 2px var(--primary);}

/* â”€â”€â”€ INNER TABS â”€â”€â”€ */
.inner-tabs{display:flex;gap:4px;margin-bottom:14px;overflow-x:auto;padding-bottom:2px;scrollbar-width:none;}
.inner-tabs::-webkit-scrollbar{display:none;}
.inner-tab{padding:8px 13px;border-radius:20px;border:2px solid var(--border);background:white;font-size:12px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;white-space:nowrap;color:var(--text-light);}
.inner-tab.active{background:var(--primary);border-color:var(--primary);color:white;font-weight:600;}
.inner-tab.admin-inner.active{background:var(--admin);border-color:var(--admin);}

/* â”€â”€â”€ MASTER TABLE â”€â”€â”€ */
.master-table{width:100%;border-collapse:collapse;font-size:13px;}
.master-table th{background:#f8fafc;padding:10px;text-align:left;border:1px solid var(--border);font-weight:700;font-size:12px;}
.master-table td{padding:8px 10px;border:1px solid var(--border);vertical-align:middle;}
.master-input{border:1.5px solid var(--border);border-radius:8px;padding:7px 10px;font-size:13px;font-family:'Noto Sans JP',sans-serif;outline:none;width:100%;background:white;color:var(--text);}
.master-input:focus{border-color:var(--admin);}
.emoji-picker{display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;}
.emoji-opt{font-size:18px;cursor:pointer;padding:4px 5px;border-radius:6px;border:2px solid transparent;}
.emoji-opt:hover,.emoji-opt.sel{border-color:var(--admin);background:#f5f3ff;}
.order-badge{display:inline-block;width:22px;height:22px;border-radius:50%;background:#e2e8f0;font-size:11px;font-weight:700;text-align:center;line-height:22px;color:var(--text-light);}
.cat-section{margin-bottom:10px;border:1px solid var(--border);border-radius:10px;overflow:hidden;}
.cat-section-header{background:#f8fafc;padding:10px 14px;display:flex;align-items:center;gap:8px;font-weight:600;font-size:13px;}
.cat-section-body{padding:8px 14px;overflow-x:auto;}

/* â”€â”€â”€ ALERT â”€â”€â”€ */
.alert{border-radius:10px;padding:10px 13px;font-size:13px;margin-bottom:12px;display:flex;gap:8px;align-items:flex-start;}
.alert-info{background:#eff6ff;color:#1e40af;border:1px solid #bfdbfe;}
.alert-warning{background:#fef3c7;color:#92400e;border:1px solid #fde68a;}
.alert-success{background:var(--primary-light);color:var(--primary-dark);border:1px solid #86efac;}
.alert-admin{background:#f5f3ff;color:#6d28d9;border:1px solid #ddd6fe;}

/* â”€â”€â”€ FREQ BTNS â”€â”€â”€ */
.freq-options{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.freq-btn{padding:7px 13px;border-radius:20px;border:2px solid var(--border);background:white;font-size:12px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;color:var(--text);white-space:nowrap;}
.freq-btn.active{background:var(--primary);border-color:var(--primary);color:white;font-weight:600;}

/* â”€â”€â”€ SUCCESS â”€â”€â”€ */
.success-screen{text-align:center;padding:36px 16px;}
.success-icon{width:72px;height:72px;background:var(--primary-light);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px;animation:popIn .4s cubic-bezier(.175,.885,.32,1.275);}
@keyframes popIn{0%{transform:scale(0)}100%{transform:scale(1)}}
.line-bubble{background:var(--primary);color:white;border-radius:12px 12px 12px 3px;padding:10px 14px;font-size:13px;line-height:1.7;display:inline-block;max-width:82%;}

.hidden{display:none!important;}
.mt-8{margin-top:8px;}.mt-12{margin-top:12px;}.mt-16{margin-top:16px;}
.label{font-size:13px;font-weight:600;margin-bottom:8px;display:block;color:var(--text);}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div><div class="header-title">æ¥­å‹™å®Ÿç¸¾ç®¡ç†</div><div class="header-sub">Work Report System v4</div></div>
    <div class="user-area">
      <div class="user-badge">ğŸ‘¤ ç”°ä¸­ ä¸€éƒ</div>
      <button class="admin-btn" id="adminToggleBtn" onclick="toggleAdminMode()">âš™ ç®¡ç†è€…</button>
    </div>
  </div>
  <div class="nav-tabs" id="mainNavTabs">
    <button class="nav-tab active" onclick="switchTab('input',this)">ğŸ“ å…¥åŠ›</button>
    <button class="nav-tab" onclick="switchTab('aggregate',this)">ğŸ“‘ é›†è¨ˆ</button>
    <button class="nav-tab" onclick="switchTab('dashboard',this)">ğŸ“Š åˆ†æ</button>
    <button class="nav-tab" onclick="switchTab('plan',this)">ğŸ“‹ è¨ˆç”»</button>
    <button class="nav-tab" onclick="switchTab('settings',this)">âš™ï¸ è¨­å®š</button>
    <button class="nav-tab admin-tab hidden" id="adminNavTab" onclick="switchTab('admin',this)">ğŸ”‘ ç®¡ç†è€…</button>
  </div>
</div>

<!-- =============================== INPUT =============================== -->
<div id="screen-input" class="screen active">

  <!-- STEP 0: æ—¥ä»˜ãƒ»æœŸé–“ -->
  <div id="step-0" class="card">
    <div class="step-indicator">
      <div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
    </div>
    <div class="step-title">æ¥­å‹™å®Ÿç¸¾ã®å…¥åŠ›</div>
    <div class="step-sub">å¯¾è±¡æ—¥ä»˜ã¨å ±å‘ŠæœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>

    <label class="label">ğŸ“… å¯¾è±¡æ—¥ä»˜</label>
    <div class="date-row">
      <input type="date" class="date-input" id="reportDate" onchange="onDateChange()">
      <button class="btn-small" onclick="setToday()">ä»Šæ—¥</button>
    </div>
    <div id="past-locked-msg" class="locked-badge hidden">ğŸ”’ éå»æ—¥ä»˜ã®å…¥åŠ›å†…å®¹ã¯ä¿®æ­£ã§ãã¾ã›ã‚“ï¼ˆå‚ç…§ã®ã¿ï¼‰</div>

    <label class="label">â± å ±å‘Šå¯¾è±¡æœŸé–“</label>
    <div class="freq-options" id="periodModeGroup">
      <button class="freq-btn active" onclick="setPeriodMode('1h',this)">1æ™‚é–“</button>
      <button class="freq-btn" onclick="setPeriodMode('2h',this)">2æ™‚é–“</button>
      <button class="freq-btn" onclick="setPeriodMode('3h',this)">3æ™‚é–“</button>
      <button class="freq-btn" onclick="setPeriodMode('4h',this)">4æ™‚é–“</button>
      <button class="freq-btn" onclick="setPeriodMode('allday',this)">çµ‚æ—¥</button>
      <button class="freq-btn" onclick="setPeriodMode('custom',this)">ã‚«ã‚¹ã‚¿ãƒ </button>
    </div>

    <!-- 1æ™‚é–“ -->
    <div id="period-1h">
      <label class="label">é–‹å§‹æ™‚åˆ»ã‚’é¸æŠï¼ˆ1æ™‚é–“ï¼‰</label>
      <div class="hour-grid col3" id="radio-1h-grid"></div>
    </div>

    <!-- 2æ™‚é–“ -->
    <div id="period-2h" class="hidden">
      <label class="label">é–‹å§‹æ™‚åˆ»ã‚’é¸æŠï¼ˆ2æ™‚é–“ï¼‰</label>
      <div class="hour-grid col3" id="radio-2h-grid"></div>
    </div>

    <!-- 3æ™‚é–“ -->
    <div id="period-3h" class="hidden">
      <label class="label">é–‹å§‹æ™‚åˆ»ã‚’é¸æŠï¼ˆ3æ™‚é–“ï¼‰</label>
      <div class="hour-grid col3" id="radio-3h-grid"></div>
    </div>

    <!-- 4æ™‚é–“ -->
    <div id="period-4h" class="hidden">
      <label class="label">é–‹å§‹æ™‚åˆ»ã‚’é¸æŠï¼ˆ4æ™‚é–“ï¼‰</label>
      <div class="hour-grid col3" id="radio-4h-grid"></div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ  -->
    <div id="period-custom" class="hidden">
      <div style="display:flex;gap:10px;align-items:center;">
        <div style="flex:1;"><label class="label" style="margin-bottom:4px;">é–‹å§‹</label><input type="time" class="date-input" id="customStart" value="09:00"></div>
        <div style="flex:1;"><label class="label" style="margin-bottom:4px;">çµ‚äº†</label><input type="time" class="date-input" id="customEnd" value="12:00"></div>
      </div>
    </div>

    <button class="btn-primary mt-12" onclick="goStep(1)">æ¬¡ã¸ï¼šæ¥­å‹™åŒºåˆ†ã‚’é¸æŠ â†’</button>
  </div>

  <!-- STEP 1: æ¥­å‹™ç¨®é¡ -->
  <div id="step-1" class="card hidden">
    <div class="step-indicator">
      <div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div><div class="step-dot"></div>
    </div>
    <div class="step-title">æ¥­å‹™ã®ç¨®é¡ã¯ï¼Ÿ</div>
    <div class="step-sub" id="step1-period-label">æ¥­å‹™ã‚’æ•™ãˆã¦ãã ã•ã„</div>
    <div id="past-locked-step1" class="locked-badge hidden">ğŸ”’ éå»æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã§ãã¾ã›ã‚“</div>
    <div class="choice-grid" id="category-grid"></div>
    <button class="btn-secondary" onclick="goStep(0)">â† æˆ»ã‚‹</button>
  </div>

  <!-- STEP 2: æ¥­å‹™å†…å®¹ -->
  <div id="step-2" class="card hidden">
    <div class="step-indicator">
      <div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div>
    </div>
    <div class="step-title" id="step2-title">æ¥­å‹™å†…å®¹</div>
    <div class="step-sub">å…·ä½“çš„ãªæ¥­å‹™ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="choice-grid" id="subcategory-grid"></div>
    <button class="btn-secondary" onclick="goStep(1)">â† æˆ»ã‚‹</button>
  </div>

  <!-- STEP 3A: é¡§å®¢ -->
  <div id="step-3a" class="card hidden">
    <div class="step-indicator">
      <div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div>
    </div>
    <div class="step-title">ãŠå®¢æ§˜ã‚’é¸æŠ</div>
    <div class="step-sub">å¯¾å¿œã—ãŸæ‹…å½“é¡§å®¢ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="choice-grid single" id="customer-choice-list"></div>
    <button class="btn-secondary" onclick="goStep(2)">â† æˆ»ã‚‹</button>
  </div>

  <!-- STEP 3B: é–‹ç™ºæ©Ÿèƒ½ -->
  <div id="step-3b" class="card hidden">
    <div class="step-indicator">
      <div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div>
    </div>
    <div class="step-title">é–‹ç™ºæ¥­å‹™ã®è©³ç´°</div>
    <div class="step-sub">æ‹…å½“æ©Ÿèƒ½ã‚’é¸æŠã—ã€ä»Šé€±ã®é€²æ—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
    <label class="label">æ©Ÿèƒ½ã‚’é¸æŠ</label>
    <div class="feature-radio-list" id="feature-radio-list"></div>
    <div id="feature-plan-info" class="alert alert-info hidden"></div>
    <div class="progress-section">
      <div class="progress-label"><span class="label" style="margin:0;">ä»Šé€±ã®é€²æ—ç‡</span><span class="progress-value" id="progressVal">50%</span></div>
      <input type="range" id="progressSlider" min="0" max="100" value="50" oninput="updateProgress(this.value)">
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-light);margin-top:3px;"><span>0%</span><span>25%</span><span>50%</span><span>75%</span><span>100%</span></div>
    </div>
    <button class="btn-secondary" onclick="goStep(2)">â† æˆ»ã‚‹</button>
    <button class="btn-primary mt-8" onclick="goStep(4)">æ¬¡ã¸ â†’</button>
  </div>

  <!-- STEP 4: ç¢ºèª -->
  <div id="step-4" class="card hidden">
    <div class="step-indicator">
      <div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div>
    </div>
    <div class="step-title">ç¢ºèªãƒ»é€ä¿¡</div>
    <div class="card" style="background:var(--primary-light);border-color:var(--primary);margin-bottom:14px;padding:14px;">
      <div class="card-title">å…¥åŠ›å†…å®¹</div>
      <div class="summary-item"><span class="summary-label">æ°å</span><span class="summary-value" id="sum-name">ç”°ä¸­ ä¸€éƒ</span></div>
      <div class="summary-item"><span class="summary-label">æ—¥ä»˜</span><span class="summary-value" id="sum-date">-</span></div>
      <div class="summary-item"><span class="summary-label">é–‹å§‹æ™‚é–“</span><span class="summary-value" id="sum-start">-</span></div>
      <div class="summary-item"><span class="summary-label">çµ‚äº†æ™‚é–“</span><span class="summary-value" id="sum-end">-</span></div>
      <div class="summary-item"><span class="summary-label">æ¥­å‹™åˆ†é¡</span><span class="summary-value" id="sum-cat">-</span></div>
      <div class="summary-item"><span class="summary-label">æ¥­å‹™å†…å®¹</span><span class="summary-value" id="sum-sub">-</span></div>
      <div class="summary-item hidden" id="sum-customer-row"><span class="summary-label">æ‹…å½“é¡§å®¢</span><span class="summary-value" id="sum-customer">-</span></div>
      <div class="summary-item hidden" id="sum-feature-row"><span class="summary-label">é–‹ç™ºæ©Ÿèƒ½</span><span class="summary-value" id="sum-feature">-</span></div>
      <div class="summary-item hidden" id="sum-progress-row"><span class="summary-label">é€²æ—ç‡</span><span class="summary-value" id="sum-progress">-</span></div>
    </div>
    <label class="label">ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
    <textarea class="text-input" id="memoText" rows="3" placeholder="ç‰¹è¨˜äº‹é …ãªã©..."></textarea>
    <button class="btn-primary mt-12" onclick="submitReport()">âœ… é€ä¿¡ã™ã‚‹</button>
    <button class="btn-secondary mt-8" onclick="goStep(3)">â† æˆ»ã‚‹</button>
  </div>

  <!-- SUCCESS -->
  <div id="step-success" class="card hidden">
    <div class="success-screen">
      <div class="success-icon">âœ…</div>
      <div class="step-title">é€ä¿¡å®Œäº†ï¼</div>
      <div class="step-sub">æ¥­å‹™å®Ÿç¸¾ãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸã€‚<br>ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼</div>
      <button class="btn-primary mt-16" onclick="resetForm()">ï¼‹ æ¬¡ã®æ¥­å‹™ã‚’å…¥åŠ›</button>
    </div>
  </div>
</div>

<!-- =============================== AGGREGATE =============================== -->
<div id="screen-aggregate" class="screen">
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:0;">é›†è¨ˆãƒ»ä¸€è¦§</div>
      <div style="display:flex;gap:6px;">
        <button class="btn-small teal" onclick="exportAggregate()">â¬‡ Excelå‡ºåŠ›</button>
        <button class="btn-small" onclick="refreshAggregate()">ğŸ”„ æ›´æ–°</button>
      </div>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="filter-bar">
      <select class="filter-select" id="filter-name" onchange="applyFilter()">
        <option value="">ğŸ‘¤ å…¨å“¡</option>
      </select>
      <input type="date" class="filter-input" id="filter-date-from" onchange="applyFilter()" placeholder="é–‹å§‹æ—¥">
      <span style="font-size:12px;color:var(--text-light);">ã€œ</span>
      <input type="date" class="filter-input" id="filter-date-to" onchange="applyFilter()" placeholder="çµ‚äº†æ—¥">
      <select class="filter-select" id="filter-cat" onchange="applyFilter()">
        <option value="">ğŸ“‚ å…¨æ¥­å‹™åˆ†é¡</option>
      </select>
    </div>

    <!-- é›†è¨ˆã‚µãƒãƒªãƒ¼ -->
    <div class="stats-grid" style="margin-bottom:14px;" id="aggr-stats">
      <div class="stat-card"><span class="stat-number" id="aggr-count">0</span><div class="stat-label">ä»¶æ•°</div></div>
      <div class="stat-card"><span class="stat-number" id="aggr-members">0</span><div class="stat-label">ãƒ¡ãƒ³ãƒãƒ¼æ•°</div></div>
      <div class="stat-card"><span class="stat-number" id="aggr-avg-progress">-</span><div class="stat-label">å¹³å‡é€²æ—ç‡</div></div>
      <div class="stat-card"><span class="stat-number" id="aggr-customer-count">0</span><div class="stat-label">é¡§å®¢æ¥ç‚¹æ•°</div></div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;">
      <table class="aggr-table">
        <thead>
          <tr>
            <th onclick="sortTable('name')" style="cursor:pointer;">æ°å â†•</th>
            <th onclick="sortTable('date')" style="cursor:pointer;">æ—¥ä»˜ â†•</th>
            <th>é–‹å§‹æ™‚é–“</th>
            <th>çµ‚äº†æ™‚é–“</th>
            <th>ä½œæ¥­æ™‚é–“</th>
            <th>æ¥­å‹™åˆ†é¡</th>
            <th>æ¥­å‹™å†…å®¹</th>
            <th>é–‹ç™ºæ©Ÿèƒ½</th>
            <th>é€²æ—ç‡</th>
            <th>æ‹…å½“é¡§å®¢</th>
          </tr>
        </thead>
        <tbody id="aggr-tbody"></tbody>
      </table>
    </div>
    <div id="aggr-empty" class="alert alert-info mt-12">ã¾ã å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œå…¥åŠ›ã€ã‚¿ãƒ–ã‹ã‚‰å®Ÿç¸¾ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</div>
  </div>
</div>

<!-- =============================== DASHBOARD =============================== -->
<div id="screen-dashboard" class="screen">
  <div class="stats-grid">
    <div class="stat-card"><span class="stat-number" id="dash-total">0</span><div class="stat-label">ä»Šæœˆã®å ±å‘Šä»¶æ•°</div></div>
    <div class="stat-card"><span class="stat-number" id="dash-contact">0</span><div class="stat-label">é¡§å®¢æ¥ç‚¹</div></div>
    <div class="stat-card"><span class="stat-number" id="dash-avg-prog">-</span><div class="stat-label">å¹³å‡é€²æ—ç‡</div></div>
    <div class="stat-card"><span class="stat-number">4.2</span><div class="stat-label">æ¥­å‹™/æ—¥ï¼ˆå¹³å‡ï¼‰</div></div>
  </div>
  <div class="card">
    <div class="card-title">æ¥­å‹™åˆ†é¡ï¼ˆä»Šæœˆï¼‰</div>
    <div id="dash-cat-chart" class="bar-chart"></div>
  </div>
  <div class="card">
    <div class="card-title">é€±æ¬¡ é–‹ç™ºé€²æ—ï¼ˆè¨ˆç”»å¯¾æ¯”ï¼‰</div>
    <div style="overflow-x:auto;"><table class="week-table"><thead><tr><th>æ©Ÿèƒ½å</th><th>è¨ˆç”»</th><th>W1</th><th>W2</th><th>W3</th><th>ä»Šé€±</th></tr></thead><tbody id="weekly-progress-table"></tbody></table></div>
  </div>
  <div class="card">
    <div class="card-title">ç›´è¿‘ã®æ´»å‹•ãƒ­ã‚°</div>
    <ul class="timeline" id="recent-log"></ul>
  </div>
</div>

<!-- =============================== PLAN =============================== -->
<div id="screen-plan" class="screen">
  <div class="card">
    <div class="card-title">ä½œæ¥­è¨ˆç”» EXCELã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</div>
    <div class="alert alert-info" style="margin-bottom:12px;">ğŸ“Œ åˆ—é †ï¼šæ©Ÿèƒ½å / é–‹å§‹æ—¥ / çµ‚äº†æ—¥ / å·¥æ•°(h) / é¡§å®¢æ‹…å½“è€…</div>
    <div class="upload-zone" onclick="document.getElementById('excelInput').click()" ondragover="ev.preventDefault()" ondrop="onDrop(event)">
      <div style="font-size:28px;margin-bottom:6px;">ğŸ“Š</div>
      <div style="font-size:13px;color:var(--text-light);"><strong style="color:var(--primary);">ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°</strong>ã§Excelã‚’é¸æŠ</div>
    </div>
    <input type="file" id="excelInput" accept=".xlsx,.xls" class="hidden" onchange="onFileSelect(event)">
  </div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:0;">ä½œæ¥­è¨ˆç”»ä¸€è¦§</div>
      <div style="display:flex;gap:6px;">
        <button class="btn-small primary" onclick="addPlanRow()">ï¼‹ è¿½åŠ </button>
        <button class="btn-small" onclick="exportPlan()">â¬‡ å‡ºåŠ›</button>
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table class="plan-table">
        <thead><tr><th style="min-width:120px">æ©Ÿèƒ½å</th><th style="min-width:105px">é–‹å§‹æ—¥</th><th style="min-width:105px">çµ‚äº†æ—¥</th><th style="min-width:60px">å·¥æ•°h</th><th style="min-width:110px">é¡§å®¢æ‹…å½“è€…</th><th style="min-width:200px">é€±æ¬¡é€²æ—</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="planBody"></tbody>
      </table>
    </div>
    <div id="plan-empty" class="alert alert-info mt-12">Excelã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã€Œï¼‹ è¿½åŠ ã€ã§ç™»éŒ²ã—ã¦ãã ã•ã„</div>
  </div>
</div>

<!-- =============================== SETTINGS =============================== -->
<div id="screen-settings" class="screen">
  <div class="inner-tabs">
    <button class="inner-tab active" onclick="switchInner('notif',this)">ğŸ”” é€šçŸ¥</button>
    <button class="inner-tab" onclick="switchInner('holiday',this)">ğŸ“… ä¼‘æ—¥</button>
    <button class="inner-tab" onclick="switchInner('customers',this)">ğŸ‘¥ é¡§å®¢</button>
  </div>
  <div id="inner-notif">
    <div class="card">
      <div class="card-title">å…¥åŠ›ãƒªãƒã‚¤ãƒ³ãƒ‰é »åº¦</div>
      <div style="display:flex;flex-direction:column;gap:8px;" id="notifModeGroup">
        <button class="freq-btn active" style="text-align:left;border-radius:10px;padding:11px 14px;" onclick="setNotifMode('1h',this)">â± 1æ™‚é–“ã”ã¨</button>
        <button class="freq-btn" style="text-align:left;border-radius:10px;padding:11px 14px;" onclick="setNotifMode('2h',this)">ğŸ•‘ 2æ™‚é–“ã”ã¨</button>
        <button class="freq-btn" style="text-align:left;border-radius:10px;padding:11px 14px;" onclick="setNotifMode('ampm',this)">ğŸŒ åˆå‰/åˆå¾Œï¼ˆ1æ—¥2å›ï¼‰</button>
        <button class="freq-btn" style="text-align:left;border-radius:10px;padding:11px 14px;" onclick="setNotifMode('allday',this)">ğŸ“… çµ‚æ¥­æ™‚ï¼ˆ1æ—¥1å›ï¼‰</button>
        <button class="freq-btn" style="text-align:left;border-radius:10px;padding:11px 14px;" onclick="setNotifMode('custom',this)">âš™ï¸ ã‚«ã‚¹ã‚¿ãƒ æ™‚åˆ»</button>
      </div>
    </div>
    <div class="card" id="custom-time-card" style="display:none;">
      <div class="card-title">ã‚«ã‚¹ã‚¿ãƒ é€šçŸ¥æ™‚åˆ»</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <label style="border:2px solid var(--border);border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:600;">é€šçŸ¥1</span><input type="time" value="09:00" style="border:none;background:transparent;font-size:13px;outline:none;">
        </label>
        <label style="border:2px solid var(--border);border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:600;">é€šçŸ¥2</span><input type="time" value="12:00" style="border:none;background:transparent;font-size:13px;outline:none;">
        </label>
        <label style="border:2px solid var(--border);border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:600;">é€šçŸ¥3</span><input type="time" value="15:00" style="border:none;background:transparent;font-size:13px;outline:none;">
        </label>
        <label style="border:2px solid var(--border);border-radius:10px;padding:10px;display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:13px;font-weight:600;">é€šçŸ¥4</span><input type="time" value="18:00" style="border:none;background:transparent;font-size:13px;outline:none;">
        </label>
      </div>
    </div>
    <div class="card">
      <div class="card-title">é€šçŸ¥ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
      <div style="background:#f0f0f0;border-radius:12px;padding:14px;">
        <div class="line-bubble">ãŠç–²ã‚Œæ§˜ã§ã™ã€ç”°ä¸­ã•ã‚“ ğŸ‘‹<br>åˆå‰ã®æ¥­å‹™å®Ÿç¸¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>ğŸ‘‰ <u>æ¥­å‹™å®Ÿç¸¾ã‚’å…¥åŠ›ã™ã‚‹</u></div>
      </div>
    </div>
  </div>
  <div id="inner-holiday" class="hidden">
    <div class="card">
      <div class="card-title">ä¼‘æ—¥ãƒ»é€šçŸ¥è¨­å®šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</div>
      <div class="step-sub">åœŸæ—¥ãƒ»ç¥æ—¥ã¯é€šçŸ¥ãªã—ã€‚ã‚¿ãƒƒãƒ—ã§ä¼‘æ—¥é€ä¿¡ã‚ã‚Šï¼å¹³æ—¥ã‚’ä¼‘æ—¥ã«åˆ‡æ›¿å¯èƒ½ã€‚</div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <button class="btn-small" onclick="prevMonth()">â† å‰æœˆ</button>
        <span id="calMonthLabel" style="font-weight:700;font-size:14px;"></span>
        <button class="btn-small" onclick="nextMonth()">æ¬¡æœˆ â†’</button>
      </div>
      <div class="cal-header-row"><div style="color:var(--danger)">æ—¥</div><div>æœˆ</div><div>ç«</div><div>æ°´</div><div>æœ¨</div><div>é‡‘</div><div style="color:#3b82f6">åœŸ</div></div>
      <div class="holiday-grid" id="calendarGrid"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;font-size:11px;">
        <span><span style="display:inline-block;width:11px;height:11px;background:#fef2f2;border:1px solid #fecaca;border-radius:3px;vertical-align:middle;margin-right:3px;"></span>é€šçŸ¥ãªã—</span>
        <span><span style="display:inline-block;width:11px;height:11px;background:var(--primary-light);border:1px solid var(--primary);border-radius:3px;vertical-align:middle;margin-right:3px;"></span>ä¼‘æ—¥é€ä¿¡ã‚ã‚Š</span>
      </div>
    </div>
  </div>
  <div id="inner-customers" class="hidden">
    <div class="card">
      <div class="card-title">æ‹…å½“é¡§å®¢ä¸€è¦§</div>
      <div id="customerList"></div>
      <button class="btn-secondary mt-12" onclick="addCustomer()">ï¼‹ é¡§å®¢ã‚’è¿½åŠ </button>
    </div>
  </div>
</div>

<!-- =============================== ADMIN =============================== -->
<div id="screen-admin" class="screen">
  <div class="alert alert-admin">ğŸ”‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ãƒã‚¹ã‚¿è¨­å®šã¯å®Ÿç¸¾å…¥åŠ›ç”»é¢ã«å³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
  <div class="inner-tabs">
    <button class="inner-tab admin-inner active" onclick="switchInnerAdmin('catmaster',this)">ğŸ“‚ æ¥­å‹™ç¨®é¡</button>
    <button class="inner-tab admin-inner" onclick="switchInnerAdmin('submaster',this)">ğŸ“‹ æ¥­å‹™å†…å®¹</button>
  </div>
  <div id="inner-catmaster">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title admin" style="margin-bottom:0;">æ¥­å‹™ç¨®é¡ãƒã‚¹ã‚¿</div>
        <button class="btn-small purple" onclick="addCategory()">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="alert alert-info" style="margin-bottom:12px;">ã“ã“ã§ç™»éŒ²ã—ãŸæ¥­å‹™ç¨®é¡ãŒå…¥åŠ›ç”»é¢ã®é¸æŠè‚¢ã«å³æ™‚åæ˜ ã•ã‚Œã¾ã™ã€‚</div>
      <div style="overflow-x:auto;">
        <table class="master-table" id="catMasterTable">
          <thead><tr><th>é †åº</th><th>çµµæ–‡å­—</th><th>æ¥­å‹™ç¨®é¡å</th><th>æœ‰åŠ¹</th><th>é¡§å®¢é¸æŠ</th><th>é–‹ç™ºãƒ•ãƒ­ãƒ¼</th><th>æ“ä½œ</th></tr></thead>
          <tbody id="catMasterBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  <div id="inner-submaster" class="hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div class="card-title admin" style="margin-bottom:0;">æ¥­å‹™å†…å®¹ãƒã‚¹ã‚¿</div>
        <button class="btn-small purple" onclick="addSubCategory()">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="alert alert-info" style="margin-bottom:12px;">å„æ¥­å‹™ç¨®é¡ã«ç´ã¥ãæ¥­å‹™å†…å®¹ã‚’è¨­å®šã—ã¾ã™ã€‚</div>
      <div id="subMasterContent"></div>
    </div>
  </div>
</div>

<!-- =============================== SCRIPT =============================== -->
<script>
// ============================================================
// MASTER DATA
// ============================================================
let categoryMaster = [
  { id:1, emoji:'ğŸ¢', name:'ç¤¾å†…æ¥­å‹™', enabled:true, needCustomer:false, isDev:false, order:1 },
  { id:2, emoji:'ğŸ¤', name:'ç¤¾å¤–æ¥­å‹™', enabled:true, needCustomer:false, isDev:false, order:2 },
];
let subCategoryMaster = [
  { id:101, catId:1, emoji:'ğŸ“‹', name:'ç¤¾å†…ä¼šè­°',  enabled:true, needCustomer:false, isDev:false, order:1 },
  { id:102, catId:1, emoji:'ğŸ“„', name:'è³‡æ–™ä½œæˆ',  enabled:true, needCustomer:false, isDev:false, order:2 },
  { id:103, catId:1, emoji:'ğŸ’»', name:'é–‹ç™ºãƒ»å®Ÿè£…', enabled:true, needCustomer:false, isDev:true,  order:3 },
  { id:104, catId:1, emoji:'ğŸ“Œ', name:'ãã®ä»–',    enabled:true, needCustomer:false, isDev:false, order:4 },
  { id:201, catId:2, emoji:'ğŸ¤', name:'é¡§å®¢æ‰“ã¡åˆã‚ã›', enabled:true, needCustomer:true,  isDev:false, order:1 },
  { id:202, catId:2, emoji:'ğŸ“', name:'æ¬¡æœŸå¥‘ç´„äº¤æ¸‰',   enabled:true, needCustomer:true,  isDev:false, order:2 },
  { id:203, catId:2, emoji:'ğŸ› ', name:'æŠ€è¡“æ”¯æ´',       enabled:true, needCustomer:true,  isDev:false, order:3 },
  { id:204, catId:2, emoji:'âš™ï¸', name:'é–‹ç™ºæ¥­å‹™',       enabled:true, needCustomer:false, isDev:true,  order:4 },
];

// ============================================================
// REPORT DATAï¼ˆå®Ÿç¸¾ã‚¹ãƒˆã‚¢ï¼‰
// ============================================================
let reportData = [
  { id:1, name:'ç”°ä¸­ ä¸€éƒ', date:'2025-02-18', startTime:'09:00', endTime:'10:00', cat:'ç¤¾å†…æ¥­å‹™', sub:'ç¤¾å†…ä¼šè­°',   feature:'', progress:null, customer:'' },
  { id:2, name:'ç”°ä¸­ ä¸€éƒ', date:'2025-02-18', startTime:'13:00', endTime:'15:00', cat:'ç¤¾å¤–æ¥­å‹™', sub:'é¡§å®¢æ‰“ã¡åˆã‚ã›', feature:'', progress:null, customer:'Aã•ã‚“ï¼ˆæ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ï¼‰' },
  { id:3, name:'éˆ´æœ¨ èŠ±å­', date:'2025-02-19', startTime:'09:00', endTime:'12:00', cat:'ç¤¾å†…æ¥­å‹™', sub:'é–‹ç™ºãƒ»å®Ÿè£…',  feature:'ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½', progress:90, customer:'' },
  { id:4, name:'ä½è—¤ æ¬¡éƒ', date:'2025-02-19', startTime:'14:00', endTime:'16:00', cat:'ç¤¾å¤–æ¥­å‹™', sub:'é–‹ç™ºæ¥­å‹™',   feature:'APIé€£æº',    progress:40, customer:'' },
  { id:5, name:'éˆ´æœ¨ èŠ±å­', date:'2025-02-20', startTime:'10:00', endTime:'12:00', cat:'ç¤¾å¤–æ¥­å‹™', sub:'æ¬¡æœŸå¥‘ç´„äº¤æ¸‰', feature:'', progress:null, customer:'Bã•ã‚“ï¼ˆãƒ™ãƒ¼ã‚¿å•†äº‹ï¼‰' },
];
let reportIdCounter = 100;

// ============================================================
// OTHER STATE
// ============================================================
let planData = [
  { id:1, name:'ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½', start:'2025-01-06', end:'2025-01-24', effort:40, customer:'Aã•ã‚“ï¼ˆæ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ï¼‰', weeklyProgress:[30,60,90,100] },
  { id:2, name:'ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›', start:'2025-01-13', end:'2025-02-07', effort:60, customer:'Bã•ã‚“ï¼ˆãƒ™ãƒ¼ã‚¿å•†äº‹ï¼‰',        weeklyProgress:[15,40,65,0]   },
  { id:3, name:'APIé€£æº',      start:'2025-01-20', end:'2025-02-14', effort:80, customer:'Aã•ã‚“ï¼ˆæ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ï¼‰', weeklyProgress:[10,30,40,0]   },
  { id:4, name:'é€šçŸ¥æ©Ÿèƒ½',     start:'2025-02-03', end:'2025-02-28', effort:30, customer:'Cã•ã‚“ï¼ˆã‚¬ãƒ³ãƒã‚·ã‚¹ãƒ†ãƒ ï¼‰',   weeklyProgress:[0,0,20,0]     },
];
let customers = [
  { id:1, name:'Aã•ã‚“ï¼ˆæ ªå¼ä¼šç¤¾ã‚¢ãƒ«ãƒ•ã‚¡ï¼‰' },
  { id:2, name:'Bã•ã‚“ï¼ˆãƒ™ãƒ¼ã‚¿å•†äº‹ï¼‰' },
  { id:3, name:'Cã•ã‚“ï¼ˆã‚¬ãƒ³ãƒã‚·ã‚¹ãƒ†ãƒ ï¼‰' },
];
const todayObj = new Date();
const todayStr = fmtDate(todayObj);
let state = { date:todayStr, periodMode:'1h', catId:null, subCatId:null, customer:'', featureId:null, progress:50 };
let adminMode = false;
let notifMode = '1h';
let holidayOverrides = {};
let calYear = todayObj.getFullYear(), calMonth = todayObj.getMonth();
let masterIdCounter = 300;
let aggrSortKey = 'date', aggrSortAsc = false;

// ============================================================
// INIT
// ============================================================
window.onload = ()=>{
  document.getElementById('reportDate').value = todayStr;
  document.getElementById('reportDate').max = todayStr;
  buildHourRadios();
  renderCalendar();
  renderCustomerList();
  buildCategoryGrid();
  renderPlanTable();
  renderWeeklyProgressTable();
  refreshAggregate();
  renderDashboard();
};

// ============================================================
// UTILS
// ============================================================
function fmtDate(d){ return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }
function isPast(s){ return s < todayStr; }
function isWeekend(d){ return d.getDay()===0||d.getDay()===6; }
function jpHolidays(){ return ['2025-01-01','2025-01-13','2025-02-11','2025-02-23','2025-03-20','2025-04-29','2025-05-03','2025-05-04','2025-05-05','2025-07-21','2025-08-11','2025-09-15','2025-09-23','2025-10-13','2025-11-03','2025-11-23']; }
// ã€Œ7æ™‚å°ã€ã€Œ7ã€œ9æ™‚å°ã€ã®ã‚ˆã†ãªè¡¨ç¤ºãƒ©ãƒ™ãƒ«
function hourLabel1h(h){ return `${h}æ™‚å°`; }
function hourLabel2h(h){ return `${h}ã€œ${h+1}æ™‚å°`; }
function hhmm(h){ return String(h).padStart(2,'0')+':00'; }

// ============================================================
// TABS
// ============================================================
function switchTab(tab, btn){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('screen-'+tab).classList.add('active');
  btn.classList.add('active');
  if(tab==='aggregate') refreshAggregate();
  if(tab==='dashboard') renderDashboard();
}
function switchInner(id, btn){
  ['inner-notif','inner-holiday','inner-customers'].forEach(i=>document.getElementById(i).classList.add('hidden'));
  document.querySelectorAll('#screen-settings .inner-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('inner-'+id).classList.remove('hidden');
  btn.classList.add('active');
}
function switchInnerAdmin(id, btn){
  ['inner-catmaster','inner-submaster'].forEach(i=>document.getElementById(i).classList.add('hidden'));
  document.querySelectorAll('#screen-admin .inner-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('inner-'+id).classList.remove('hidden');
  btn.classList.add('active');
}

// ============================================================
// ADMIN MODE
// ============================================================
function toggleAdminMode(){
  adminMode = !adminMode;
  document.getElementById('adminToggleBtn').classList.toggle('active-admin', adminMode);
  document.getElementById('adminNavTab').classList.toggle('hidden', !adminMode);
  if(adminMode){ renderCatMasterTable(); renderSubMasterContent(); }
}

// ============================================================
// DATE
// ============================================================
function setToday(){ document.getElementById('reportDate').value=todayStr; state.date=todayStr; onDateChange(); }
function onDateChange(){
  state.date = document.getElementById('reportDate').value;
  const locked = isPast(state.date);
  document.getElementById('past-locked-msg').classList.toggle('hidden', !locked);
  document.getElementById('past-locked-step1').classList.toggle('hidden', !locked);
  buildHourRadios();
}

// ============================================================
// PERIOD MODE
// ============================================================
function setPeriodMode(mode, btn){
  state.periodMode = mode;
  document.querySelectorAll('#periodModeGroup .freq-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  ['period-1h','period-2h','period-3h','period-4h','period-custom'].forEach(id=>document.getElementById(id).classList.add('hidden'));
  const map={'1h':'period-1h','2h':'period-2h','3h':'period-3h','4h':'period-4h','custom':'period-custom'};
  if(map[mode]) document.getElementById(map[mode]).classList.remove('hidden');
}

// â”€â”€â”€â”€ 1æ™‚é–“ãƒ©ã‚¸ã‚ª: ã€Œ7æ™‚å°ã€ã€œã€Œ18æ™‚å°ã€ â”€â”€â”€â”€
function buildHourRadios(){
  const now = new Date();
  const nowH = now.getHours();
  // å„ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ = nowH - stepã€ç¯„å›²å†…ã«ã‚¯ãƒ©ãƒ³ãƒ—
  const clamp = (v, mn, mx) => Math.min(mx, Math.max(mn, v));
  const snapStep = (v, step) => Math.floor(v / step) * step;

  const def1 = clamp(nowH - 1, 7, 18);
  const def2 = clamp(snapStep(nowH - 2, 2), 7, 17);
  const def3 = clamp(snapStep(nowH - 3, 3), 7, 16);
  const def4 = clamp(snapStep(nowH - 4, 4), 7, 15);

  buildHourRadioGrid('radio-1h-grid', 7, 19, 1, def1, 'r1h', h=>`${h}æ™‚å°`);
  buildHourRadioGrid('radio-2h-grid', 7, 19, 2, def2, 'r2h', h=>`${h}ã€œ${h+1}æ™‚å°`);
  buildHourRadioGrid('radio-3h-grid', 7, 19, 3, def3, 'r3h', h=>`${h}ã€œ${h+2}æ™‚å°`);
  buildHourRadioGrid('radio-4h-grid', 7, 19, 4, def4, 'r4h', h=>`${h}ã€œ${h+3}æ™‚å°`);
}

function buildHourRadioGrid(gridId, startH, endH, step, defaultH, name, labelFn){
  const grid = document.getElementById(gridId);
  if(!grid) return;
  grid.innerHTML = '';
  for(let h = startH; h < endH; h += step){
    const isDefault = (h === defaultH);
    const item = document.createElement('div');
    item.className = 'hour-item';
    item.innerHTML = `
      <input type="radio" name="${name}" id="${name}_${h}" value="${h}" ${isDefault?'checked':''} onchange="clearDefaultMark('${name}')">
      <label for="${name}_${h}" class="hour-label${isDefault?' is-default':''}">
        <span class="hl-main">${labelFn(h)}</span>
        <span class="hl-sub">${hhmm(h)}ã€œ${hhmm(h+step)}</span>
      </label>`;
    grid.appendChild(item);
  }
}
function clearDefaultMark(name){
  document.querySelectorAll(`input[name="${name}"]`).forEach(r=>{
    document.querySelector(`label[for="${r.id}"]`)?.classList.remove('is-default');
  });
}

// â”€â”€â”€â”€ æœŸé–“ãƒ©ãƒ™ãƒ«å–å¾— â”€â”€â”€â”€
function getPeriodInfo(){
  switch(state.periodMode){
    case '1h':{
      const r = document.querySelector('input[name="r1h"]:checked');
      if(!r) return { startTime:'', endTime:'', label:'æœªé¸æŠ' };
      const h = parseInt(r.value);
      return { startTime: hhmm(h), endTime: hhmm(h+1), label:`${h}æ™‚å°ï¼ˆ${hhmm(h)}ã€œ${hhmm(h+1)}ï¼‰` };
    }
    case '2h':{
      const r = document.querySelector('input[name="r2h"]:checked');
      if(!r) return { startTime:'', endTime:'', label:'æœªé¸æŠ' };
      const h = parseInt(r.value);
      return { startTime: hhmm(h), endTime: hhmm(h+2), label:`${h}ã€œ${h+1}æ™‚å°ï¼ˆ${hhmm(h)}ã€œ${hhmm(h+2)}ï¼‰` };
    }
    case '3h':{
      const r = document.querySelector('input[name="r3h"]:checked');
      if(!r) return { startTime:'', endTime:'', label:'æœªé¸æŠ' };
      const h = parseInt(r.value);
      return { startTime: hhmm(h), endTime: hhmm(h+3), label:`${h}ã€œ${h+2}æ™‚å°ï¼ˆ${hhmm(h)}ã€œ${hhmm(h+3)}ï¼‰` };
    }
    case '4h':{
      const r = document.querySelector('input[name="r4h"]:checked');
      if(!r) return { startTime:'', endTime:'', label:'æœªé¸æŠ' };
      const h = parseInt(r.value);
      return { startTime: hhmm(h), endTime: hhmm(h+4), label:`${h}ã€œ${h+3}æ™‚å°ï¼ˆ${hhmm(h)}ã€œ${hhmm(h+4)}ï¼‰` };
    }
    case 'allday':
      return { startTime:'07:00', endTime:'19:00', label:'çµ‚æ—¥ï¼ˆ07:00ã€œ19:00ï¼‰' };
    case 'custom':{
      const s = document.getElementById('customStart').value;
      const e = document.getElementById('customEnd').value;
      return { startTime: s, endTime: e, label:`${s}ã€œ${e}` };
    }
  }
  return { startTime:'', endTime:'', label:'' };
}

// ============================================================
// STEPS
// ============================================================
function hideAllSteps(){
  ['step-0','step-1','step-2','step-3a','step-3b','step-4','step-success'].forEach(id=>document.getElementById(id).classList.add('hidden'));
}
function showEl(id){ document.getElementById(id).classList.remove('hidden'); }

function goStep(n){
  hideAllSteps();
  if(n===0) showEl('step-0');
  else if(n===1){
    const pi = getPeriodInfo();
    document.getElementById('step1-period-label').textContent = pi.label+'ã®æ¥­å‹™ã‚’æ•™ãˆã¦ãã ã•ã„';
    buildCategoryGrid();
    showEl('step-1');
  }
  else if(n===2){ buildSubCategoryGrid(); showEl('step-2'); }
  else if(n===3){
    const sub = subCategoryMaster.find(s=>s.id===state.subCatId);
    if(sub && sub.needCustomer){ buildCustomerChoiceList(); showEl('step-3a'); }
    else if(sub && sub.isDev){ buildFeatureRadioList(); showEl('step-3b'); }
    else goStep(4);
    return;
  }
  else if(n===4){ updateSummary(); showEl('step-4'); }
  window.scrollTo(0,0);
}

// ============================================================
// DYNAMIC GRIDS
// ============================================================
function buildCategoryGrid(){
  const grid = document.getElementById('category-grid');
  grid.innerHTML = '';
  const locked = isPast(state.date);
  const cats = categoryMaster.filter(c=>c.enabled).sort((a,b)=>a.order-b.order);
  grid.style.gridTemplateColumns = `repeat(${Math.min(cats.length,2)}, 1fr)`;
  cats.forEach(cat=>{
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.disabled = locked;
    btn.innerHTML = `<span class="emoji">${cat.emoji}</span>${cat.name}`;
    btn.onclick = ()=>selectCategory(cat.id, btn);
    grid.appendChild(btn);
  });
}
function buildSubCategoryGrid(){
  const grid = document.getElementById('subcategory-grid');
  grid.innerHTML = '';
  const cat = categoryMaster.find(c=>c.id===state.catId);
  document.getElementById('step2-title').textContent = (cat?cat.name:'æ¥­å‹™')+'ã®å†…å®¹';
  const subs = subCategoryMaster.filter(s=>s.catId===state.catId&&s.enabled).sort((a,b)=>a.order-b.order);
  grid.style.gridTemplateColumns = `repeat(${Math.min(subs.length,2)}, 1fr)`;
  subs.forEach(sub=>{
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.innerHTML = `<span class="emoji">${sub.emoji}</span>${sub.name}`;
    btn.onclick = ()=>selectSubCat(sub.id, btn);
    grid.appendChild(btn);
  });
}
function buildCustomerChoiceList(){
  const list = document.getElementById('customer-choice-list');
  list.innerHTML = '';
  [...customers, {id:-1, name:'ãã®ä»–'}].forEach(c=>{
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = (c.id===-1?'ğŸ“Œ ':'ğŸ‘¤ ')+c.name;
    btn.onclick = ()=>selectCustomer(c.name, btn);
    list.appendChild(btn);
  });
}
function buildFeatureRadioList(){
  const list = document.getElementById('feature-radio-list');
  list.innerHTML = '';
  if(!planData.length){
    list.innerHTML = '<div class="alert alert-info">è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã€Œè¨ˆç”»ã€ã‚¿ãƒ–ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
    return;
  }
  planData.forEach(p=>{
    const lastW = p.weeklyProgress.filter(v=>v>0);
    const lp = lastW.length ? lastW[lastW.length-1] : 0;
    const item = document.createElement('div');
    item.className = 'feature-radio-item';
    item.innerHTML = `
      <input type="radio" name="featureRadio" id="fr_${p.id}" value="${p.id}" onchange="onFeatureRadioChange(${p.id})">
      <label for="fr_${p.id}" class="feature-radio-label">
        <div class="fr-dot"></div>
        <div class="fr-info">
          <div class="fr-name">${p.name}</div>
          <div class="fr-meta">å·¥æ•°: ${p.effort}h ï½œ ${p.start} ã€œ ${p.end}</div>
          <div class="fr-bar"><div class="fr-bar-fill" style="width:${lp}%"></div></div>
        </div>
        <div class="fr-badge">${lp}%</div>
      </label>`;
    list.appendChild(item);
  });
}
function onFeatureRadioChange(id){
  state.featureId = id;
  const plan = planData.find(p=>p.id===id);
  const info = document.getElementById('feature-plan-info');
  if(plan){
    const lastW = plan.weeklyProgress.filter(v=>v>0);
    const lp = lastW.length ? lastW[lastW.length-1] : 0;
    info.classList.remove('hidden');
    info.innerHTML = `ğŸ“‹ <strong>${plan.name}</strong>ï½œå·¥æ•°: ${plan.effort}hï½œæ‹…å½“: ${plan.customer}<br>å‰é€±é€²æ—: <strong>${lp}%</strong>`;
    document.getElementById('progressSlider').value = lp;
    updateProgress(lp);
  } else info.classList.add('hidden');
}

// ============================================================
// SELECT HANDLERS
// ============================================================
function selectCategory(catId, btn){
  if(isPast(state.date)) return;
  btn.closest('.choice-grid').querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  state.catId = catId;
  setTimeout(()=>goStep(2), 180);
}
function selectSubCat(subId, btn){
  btn.closest('.choice-grid').querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  state.subCatId = subId;
  setTimeout(()=>goStep(3), 180);
}
function selectCustomer(cust, btn){
  btn.closest('.choice-grid').querySelectorAll('.choice-btn').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  state.customer = cust;
  setTimeout(()=>goStep(4), 180);
}
function updateProgress(val){
  state.progress = parseInt(val);
  document.getElementById('progressVal').textContent = val+'%';
  const slider = document.getElementById('progressSlider');
  slider.style.background = `linear-gradient(to right,var(--primary) 0%,var(--primary) ${val}%,var(--border) ${val}%)`;
}

// ============================================================
// SUMMARY & SUBMIT
// ============================================================
function updateSummary(){
  const pi = getPeriodInfo();
  const cat = categoryMaster.find(c=>c.id===state.catId);
  const sub = subCategoryMaster.find(s=>s.id===state.subCatId);
  document.getElementById('sum-date').textContent = state.date;
  document.getElementById('sum-start').textContent = pi.startTime||'-';
  document.getElementById('sum-end').textContent   = pi.endTime||'-';
  document.getElementById('sum-cat').textContent   = cat ? cat.emoji+' '+cat.name : '-';
  document.getElementById('sum-sub').textContent   = sub ? sub.emoji+' '+sub.name : '-';
  const isCust = sub && sub.needCustomer;
  const isDev  = sub && sub.isDev;
  document.getElementById('sum-customer-row').classList.toggle('hidden',!isCust);
  document.getElementById('sum-feature-row').classList.toggle('hidden',!isDev);
  document.getElementById('sum-progress-row').classList.toggle('hidden',!isDev);
  if(isCust) document.getElementById('sum-customer').textContent = state.customer;
  if(isDev){
    const plan = planData.find(p=>p.id===state.featureId);
    document.getElementById('sum-feature').textContent  = plan ? plan.name : 'æœªé¸æŠ';
    document.getElementById('sum-progress').textContent = state.progress+'%';
  }
}

function submitReport(){
  if(isPast(state.date)){ alert('éå»æ—¥ä»˜ã®å†…å®¹ã¯ä¿®æ­£ã§ãã¾ã›ã‚“'); return; }
  const pi  = getPeriodInfo();
  const cat = categoryMaster.find(c=>c.id===state.catId);
  const sub = subCategoryMaster.find(s=>s.id===state.subCatId);
  const plan= planData.find(p=>p.id===state.featureId);
  const isDev  = sub && sub.isDev;
  const isCust = sub && sub.needCustomer;
  reportIdCounter++;
  reportData.push({
    id: reportIdCounter,
    name:     'ç”°ä¸­ ä¸€éƒ', // å®Ÿéš›ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    date:     state.date,
    startTime: pi.startTime,
    endTime:   pi.endTime,
    cat:      cat ? cat.name : '',
    sub:      sub ? sub.name : '',
    feature:  isDev && plan ? plan.name : '',
    progress: isDev ? state.progress : null,
    customer: isCust ? state.customer : '',
  });
  hideAllSteps();
  showEl('step-success');
  window.scrollTo(0,0);
}

function resetForm(){
  state = { date:todayStr, periodMode:'1h', catId:null, subCatId:null, customer:'', featureId:null, progress:50 };
  document.getElementById('memoText').value='';
  document.getElementById('progressSlider').value=50;
  updateProgress(50);
  goStep(0);
}

// ============================================================
// AGGREGATE
// ============================================================
function refreshAggregate(){
  // populate filter dropdowns
  const names = [...new Set(reportData.map(r=>r.name))].sort();
  const nameEl = document.getElementById('filter-name');
  const curName = nameEl.value;
  nameEl.innerHTML = '<option value="">ğŸ‘¤ å…¨å“¡</option>';
  names.forEach(n=>nameEl.innerHTML += `<option value="${n}" ${curName===n?'selected':''}>${n}</option>`);

  const cats = [...new Set(reportData.map(r=>r.cat))].sort();
  const catEl = document.getElementById('filter-cat');
  const curCat = catEl.value;
  catEl.innerHTML = '<option value="">ğŸ“‚ å…¨æ¥­å‹™åˆ†é¡</option>';
  cats.forEach(c=>catEl.innerHTML += `<option value="${c}" ${curCat===c?'selected':''}>${c}</option>`);

  applyFilter();
}

function applyFilter(){
  const nameF    = document.getElementById('filter-name').value;
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo   = document.getElementById('filter-date-to').value;
  const catF     = document.getElementById('filter-cat').value;

  let rows = reportData.filter(r=>{
    if(nameF && r.name !== nameF) return false;
    if(dateFrom && r.date < dateFrom) return false;
    if(dateTo   && r.date > dateTo)   return false;
    if(catF && r.cat !== catF) return false;
    return true;
  });

  // sort
  rows.sort((a,b)=>{
    let av = a[aggrSortKey]||'', bv = b[aggrSortKey]||'';
    if(av < bv) return aggrSortAsc ? -1 : 1;
    if(av > bv) return aggrSortAsc ? 1 : -1;
    return 0;
  });

  renderAggrTable(rows);

  // summary stats
  document.getElementById('aggr-count').textContent = rows.length;
  document.getElementById('aggr-members').textContent = new Set(rows.map(r=>r.name)).size;
  const progRows = rows.filter(r=>r.progress!==null);
  document.getElementById('aggr-avg-progress').textContent = progRows.length ? Math.round(progRows.reduce((s,r)=>s+r.progress,0)/progRows.length)+'%' : '-';
  document.getElementById('aggr-customer-count').textContent = rows.filter(r=>r.customer).length;
}

function calcWorkTime(start, end){
  if(!start || !end) return '-';
  const [sh,sm] = start.split(':').map(Number);
  const [eh,em] = end.split(':').map(Number);
  const mins = (eh*60+em) - (sh*60+sm);
  if(mins <= 0) return '-';
  const h = Math.floor(mins/60);
  const m = mins % 60;
  return h > 0 ? (m > 0 ? `${h}æ™‚é–“${m}åˆ†` : `${h}æ™‚é–“`) : `${m}åˆ†`;
}

function renderAggrTable(rows){
  const tbody = document.getElementById('aggr-tbody');
  const empty = document.getElementById('aggr-empty');
  tbody.innerHTML = '';
  if(!rows.length){ empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  rows.forEach(r=>{
    const workTime = calcWorkTime(r.startTime, r.endTime);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:600;">${r.name}</td>
      <td>${r.date}</td>
      <td>${r.startTime||'-'}</td>
      <td>${r.endTime||'-'}</td>
      <td style="text-align:center;font-weight:600;color:var(--accent);">${workTime}</td>
      <td><span class="badge badge-blue" style="margin:0;">${r.cat}</span></td>
      <td>${r.sub}</td>
      <td>${r.feature||'-'}</td>
      <td>${r.progress!==null ? r.progress+'%' : '-'}</td>
      <td>${r.customer||'-'}</td>`;
    tbody.appendChild(tr);
  });
}

function sortTable(key){
  if(aggrSortKey===key) aggrSortAsc=!aggrSortAsc;
  else { aggrSortKey=key; aggrSortAsc=true; }
  applyFilter();
}

function exportAggregate(){
  const nameF    = document.getElementById('filter-name').value;
  const dateFrom = document.getElementById('filter-date-from').value;
  const dateTo   = document.getElementById('filter-date-to').value;
  const catF     = document.getElementById('filter-cat').value;
  let rows = reportData.filter(r=>{
    if(nameF && r.name!==nameF) return false;
    if(dateFrom && r.date<dateFrom) return false;
    if(dateTo && r.date>dateTo) return false;
    if(catF && r.cat!==catF) return false;
    return true;
  });
  rows.sort((a,b)=>{ const c=a.date>b.date?1:-1; return aggrSortAsc?c:-c; });

  const header=['æ°å','æ—¥ä»˜','é–‹å§‹æ™‚é–“','çµ‚äº†æ™‚é–“','ä½œæ¥­æ™‚é–“','æ¥­å‹™åˆ†é¡','æ¥­å‹™å†…å®¹','é–‹ç™ºæ©Ÿèƒ½','é€²æ—ç‡','æ‹…å½“é¡§å®¢'];
  const data=[header, ...rows.map(r=>[
    r.name, r.date, r.startTime, r.endTime,
    calcWorkTime(r.startTime, r.endTime),
    r.cat, r.sub, r.feature||'',
    r.progress!==null ? r.progress+'%' : '',
    r.customer||''
  ])];
  const ws = XLSX.utils.aoa_to_sheet(data);
  // column widths
  ws['!cols'] = [14,12,10,10,10,14,16,16,10,20].map(w=>({wch:w}));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,'æ¥­å‹™å®Ÿç¸¾é›†è¨ˆ',ws);
  XLSX.writeFile(wb, 'æ¥­å‹™å®Ÿç¸¾_'+todayStr+'.xlsx');
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard(){
  const thisMonth = todayStr.slice(0,7);
  const monthRows = reportData.filter(r=>r.date.startsWith(thisMonth));
  document.getElementById('dash-total').textContent   = monthRows.length;
  document.getElementById('dash-contact').textContent = monthRows.filter(r=>r.customer).length;
  const pr = monthRows.filter(r=>r.progress!==null);
  document.getElementById('dash-avg-prog').textContent = pr.length ? Math.round(pr.reduce((s,r)=>s+r.progress,0)/pr.length)+'%' : '-';

  // cat bar chart
  const catChart = document.getElementById('dash-cat-chart');
  const catCounts = {};
  monthRows.forEach(r=>catCounts[r.cat]=(catCounts[r.cat]||0)+1);
  const maxC = Math.max(1,...Object.values(catCounts));
  catChart.innerHTML = Object.entries(catCounts).map(([name,cnt])=>`
    <div class="bar-row">
      <div class="bar-name">${name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${Math.round(cnt/maxC*100)}%;background:var(--primary)"></div></div>
      <div class="bar-val">${cnt}ä»¶</div>
    </div>`).join('');

  // recent log
  const logEl = document.getElementById('recent-log');
  const recent = [...reportData].sort((a,b)=>b.date>a.date?1:-1).slice(0,5);
  logEl.innerHTML = recent.map(r=>`
    <li class="timeline-item">
      <div class="tl-dot"></div>
      <div class="tl-content">
        <div class="tl-name">${r.name} <span class="badge badge-green">${r.cat}</span></div>
        <div class="tl-detail">${r.sub}${r.customer?' â†’ '+r.customer:''}${r.feature?' â†’ '+r.feature+(r.progress!==null?' ('+r.progress+'%)':''):''}</div>
      </div>
      <div class="tl-time">${r.date.slice(5)}<br>${r.startTime}</div>
    </li>`).join('');

  renderWeeklyProgressTable();
}

// ============================================================
// PLAN
// ============================================================
function renderWeeklyProgressTable(){
  const tbody=document.getElementById('weekly-progress-table');
  if(!tbody) return;
  tbody.innerHTML='';
  planData.forEach(p=>{
    const wP=[25,25,25,25];
    let cells=`<td style="font-weight:600;font-size:12px;">${p.name}</td><td style="text-align:center;color:var(--text-light)">${p.effort}h</td>`;
    p.weeklyProgress.forEach((prog,i)=>{
      const color=prog===0?'var(--border)':prog>=wP[i]?'var(--primary)':prog>=wP[i]*.7?'var(--warning)':'var(--danger)';
      cells+=`<td style="text-align:center;"><div style="font-size:12px;font-weight:600;color:${prog===0?'var(--text-light)':color}">${prog||'-'}%</div><div class="prog-mini"><div class="prog-mini-fill" style="width:${prog}%;background:${color}"></div></div><div style="font-size:10px;color:var(--text-light)">è¨ˆç”»${wP[i]}%</div></td>`;
    });
    const tr=document.createElement('tr');
    tr.innerHTML=cells;
    tbody.appendChild(tr);
  });
}
function renderPlanTable(){
  const tbody=document.getElementById('planBody');
  const empty=document.getElementById('plan-empty');
  tbody.innerHTML='';
  if(!planData.length){ empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');
  planData.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    const wk=p.weeklyProgress.map((v,wi)=>`
      <div style="display:flex;align-items:center;gap:4px;margin-bottom:3px;">
        <span style="font-size:10px;color:var(--text-light);width:22px">W${wi+1}</span>
        <input type="number" min="0" max="100" value="${v}" onchange="updateWeekProgress(${idx},${wi},this.value)" style="width:48px;border:1px solid var(--border);border-radius:4px;padding:3px 5px;font-size:12px;text-align:center;">
        <span style="font-size:10px;color:var(--text-light)">%</span>
        <div style="flex:1;height:4px;background:var(--border);border-radius:2px"><div style="width:${v}%;height:100%;background:var(--primary);border-radius:2px"></div></div>
      </div>`).join('');
    const custOpts=customers.map(c=>`<option ${c.name===p.customer?'selected':''}>${c.name}</option>`).join('')+'<option>ãã®ä»–</option>';
    tr.innerHTML=`
      <td><input type="text" value="${p.name}" onchange="planData[${idx}].name=this.value;renderWeeklyProgressTable();"></td>
      <td><input type="date" value="${p.start}" onchange="planData[${idx}].start=this.value;"></td>
      <td><input type="date" value="${p.end}" onchange="planData[${idx}].end=this.value;"></td>
      <td><input type="number" value="${p.effort}" min="0" onchange="planData[${idx}].effort=parseInt(this.value)||0;"></td>
      <td><select onchange="planData[${idx}].customer=this.value;">${custOpts}</select></td>
      <td>${wk}</td>
      <td style="text-align:center"><button class="btn-small danger" onclick="deletePlanRow(${idx})">å‰Šé™¤</button></td>`;
    tbody.appendChild(tr);
  });
}
function updateWeekProgress(pi,wi,v){ planData[pi].weeklyProgress[wi]=parseInt(v)||0; renderWeeklyProgressTable(); }
function addPlanRow(){ planData.push({id:Date.now(),name:'æ–°è¦æ©Ÿèƒ½',start:todayStr,end:todayStr,effort:0,customer:customers[0]?.name||'',weeklyProgress:[0,0,0,0]}); renderPlanTable(); renderWeeklyProgressTable(); }
function deletePlanRow(i){ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ planData.splice(i,1); renderPlanTable(); renderWeeklyProgressTable(); } }
function exportPlan(){
  const d=[['æ©Ÿèƒ½å','é–‹å§‹æ—¥','çµ‚äº†æ—¥','å·¥æ•°(h)','é¡§å®¢æ‹…å½“è€…','W1%','W2%','W3%','W4%'],...planData.map(p=>[p.name,p.start,p.end,p.effort,p.customer,...p.weeklyProgress])];
  const ws=XLSX.utils.aoa_to_sheet(d);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,'ä½œæ¥­è¨ˆç”»',ws);
  XLSX.writeFile(wb,'ä½œæ¥­è¨ˆç”»_'+todayStr+'.xlsx');
}
function onDragOver(e){ e.preventDefault(); }
function onDrop(e){ e.preventDefault(); processFile(e.dataTransfer.files[0]); }
function onFileSelect(e){ processFile(e.target.files[0]); }
function processFile(file){
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(ws,{header:1});
      const nd=rows.slice(1).filter(r=>r[0]).map((r,i)=>({id:Date.now()+i,name:r[0]||'',start:r[1]||todayStr,end:r[2]||todayStr,effort:parseInt(r[3])||0,customer:r[4]||'',weeklyProgress:[0,0,0,0]}));
      if(nd.length){ planData=nd; renderPlanTable(); renderWeeklyProgressTable(); }
      else alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
    }catch(err){ alert('èª­ã¿è¾¼ã¿å¤±æ•—: '+err.message); }
  };
  reader.readAsArrayBuffer(file);
}

// ============================================================
// SETTINGS
// ============================================================
function setNotifMode(mode, btn){
  notifMode=mode;
  document.querySelectorAll('#notifModeGroup .freq-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('custom-time-card').style.display=mode==='custom'?'block':'none';
}
function renderCalendar(){
  const lbl=document.getElementById('calMonthLabel');
  const grid=document.getElementById('calendarGrid');
  lbl.textContent=`${calYear}å¹´ ${calMonth+1}æœˆ`;
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();
  const hols=jpHolidays();
  grid.innerHTML='';
  for(let i=0;i<first;i++) grid.appendChild(document.createElement('div'));
  for(let d=1;d<=days;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const dow=new Date(calYear,calMonth,d).getDay();
    const div=document.createElement('div');
    div.className='cal-day';
    div.textContent=d;
    if(ds===todayStr) div.classList.add('today-cal');
    if(holidayOverrides[ds]==='work') div.classList.add('work-override');
    else if(dow===0||dow===6) div.classList.add('weekend');
    else if(hols.includes(ds)) div.classList.add('holiday-nat');
    else div.classList.add('weekday');
    div.onclick=()=>toggleHoliday(ds,dow,hols.includes(ds));
    grid.appendChild(div);
  }
}
function toggleHoliday(ds,dow,isHol){
  const cur=holidayOverrides[ds];
  if(dow===0||dow===6||isHol){ cur==='work'?delete holidayOverrides[ds]:(holidayOverrides[ds]='work'); }
  else { cur==='holiday'?delete holidayOverrides[ds]:(holidayOverrides[ds]='holiday'); }
  renderCalendar();
}
function prevMonth(){ calMonth--; if(calMonth<0){calMonth=11;calYear--;} renderCalendar(); }
function nextMonth(){ calMonth++; if(calMonth>11){calMonth=0;calYear++;} renderCalendar(); }
function renderCustomerList(){
  const el=document.getElementById('customerList');
  if(!el) return;
  el.innerHTML='';
  customers.forEach((c,i)=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);';
    row.innerHTML=`<input type="text" value="${c.name}" class="text-input" style="flex:1;padding:8px 10px;font-size:13px;" onchange="customers[${i}].name=this.value;renderPlanTable();">
      <button class="btn-small danger" onclick="removeCustomer(${i})">å‰Šé™¤</button>`;
    el.appendChild(row);
  });
}
function addCustomer(){ customers.push({id:Date.now(),name:'æ–°è¦é¡§å®¢'}); renderCustomerList(); }
function removeCustomer(i){ if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ customers.splice(i,1); renderCustomerList(); } }

// ============================================================
// ADMIN â€“ CATEGORY MASTER
// ============================================================
const EMOJIS=['ğŸ¢','ğŸ¤','ğŸ’¼','ğŸ“Š','ğŸ”§','ğŸš€','ğŸŒ','ğŸ“±','ğŸ¯','ğŸ’¡','ğŸ“‹','âš™ï¸','ğŸ› ','ğŸ“','ğŸ­','ğŸª'];

function renderCatMasterTable(){
  const tbody=document.getElementById('catMasterBody');
  tbody.innerHTML='';
  categoryMaster.sort((a,b)=>a.order-b.order).forEach((cat,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="text-align:center;">
        <div style="display:flex;flex-direction:column;gap:2px;align-items:center;">
          <button class="btn-small" style="padding:2px 6px;font-size:10px;" onclick="moveCat(${i},-1)">â–²</button>
          <span class="order-badge">${cat.order}</span>
          <button class="btn-small" style="padding:2px 6px;font-size:10px;" onclick="moveCat(${i},1)">â–¼</button>
        </div>
      </td>
      <td>
        <span id="cat_emoji_${cat.id}" style="font-size:20px;cursor:pointer;" onclick="openEmojiPicker('cat',${cat.id})">${cat.emoji}</span>
        <div id="emoji_picker_cat_${cat.id}" class="hidden"><div class="emoji-picker">${EMOJIS.map(e=>`<span class="emoji-opt" onclick="selectEmoji('cat',${cat.id},'${e}')">${e}</span>`).join('')}</div></div>
      </td>
      <td><input class="master-input" value="${cat.name}" onchange="categoryMaster[${i}].name=this.value;buildCategoryGrid();refreshAggregate();"></td>
      <td style="text-align:center;"><label class="toggle-wrap"><input type="checkbox" ${cat.enabled?'checked':''} onchange="categoryMaster[${i}].enabled=this.checked;buildCategoryGrid();"><span class="toggle-slider"></span></label></td>
      <td style="text-align:center;"><label class="toggle-wrap"><input type="checkbox" ${cat.needCustomer?'checked':''} onchange="categoryMaster[${i}].needCustomer=this.checked;"><span class="toggle-slider"></span></label></td>
      <td style="text-align:center;"><label class="toggle-wrap"><input type="checkbox" ${cat.isDev?'checked':''} onchange="categoryMaster[${i}].isDev=this.checked;"><span class="toggle-slider"></span></label></td>
      <td style="text-align:center;"><button class="btn-small danger" onclick="deleteCat(${i})">å‰Šé™¤</button></td>`;
    tbody.appendChild(tr);
  });
}
function addCategory(){
  masterIdCounter++;
  categoryMaster.push({id:masterIdCounter,emoji:'ğŸ“Œ',name:'æ–°è¦æ¥­å‹™ç¨®é¡',enabled:true,needCustomer:false,isDev:false,order:categoryMaster.length+1});
  renderCatMasterTable(); buildCategoryGrid();
}
function deleteCat(i){
  if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ categoryMaster.splice(i,1); categoryMaster.forEach((c,j)=>c.order=j+1); renderCatMasterTable(); buildCategoryGrid(); }
}
function moveCat(i,dir){
  const j=i+dir;
  if(j<0||j>=categoryMaster.length) return;
  [categoryMaster[i].order,categoryMaster[j].order]=[categoryMaster[j].order,categoryMaster[i].order];
  categoryMaster.sort((a,b)=>a.order-b.order);
  renderCatMasterTable(); buildCategoryGrid();
}
function openEmojiPicker(type,id){ document.getElementById(`emoji_picker_${type}_${id}`)?.classList.toggle('hidden'); }
function selectEmoji(type,id,emoji){
  if(type==='cat') categoryMaster.find(c=>c.id===id).emoji=emoji;
  else subCategoryMaster.find(s=>s.id===id).emoji=emoji;
  document.getElementById(`${type}_emoji_${id}`).textContent=emoji;
  document.getElementById(`emoji_picker_${type}_${id}`)?.classList.add('hidden');
  buildCategoryGrid(); renderSubMasterContent();
}

// ============================================================
// ADMIN â€“ SUBCATEGORY MASTER
// ============================================================
function renderSubMasterContent(){
  const container=document.getElementById('subMasterContent');
  container.innerHTML='';
  categoryMaster.filter(c=>c.enabled).sort((a,b)=>a.order-b.order).forEach(cat=>{
    const subs=subCategoryMaster.filter(s=>s.catId===cat.id).sort((a,b)=>a.order-b.order);
    const section=document.createElement('div');
    section.className='cat-section';
    const rows=subs.map((sub,si)=>`
      <tr>
        <td style="text-align:center;">
          <div style="display:flex;flex-direction:column;gap:2px;align-items:center;">
            <button class="btn-small" style="padding:2px 6px;font-size:10px;" onclick="moveSub(${cat.id},${si},-1)">â–²</button>
            <span class="order-badge">${sub.order}</span>
            <button class="btn-small" style="padding:2px 6px;font-size:10px;" onclick="moveSub(${cat.id},${si},1)">â–¼</button>
          </div>
        </td>
        <td>
          <span id="sub_emoji_${sub.id}" style="font-size:18px;cursor:pointer;" onclick="openEmojiPicker('sub',${sub.id})">${sub.emoji}</span>
          <div id="emoji_picker_sub_${sub.id}" class="hidden"><div class="emoji-picker">${EMOJIS.map(e=>`<span class="emoji-opt" onclick="selectEmoji('sub',${sub.id},'${e}')">${e}</span>`).join('')}</div></div>
        </td>
        <td><input class="master-input" value="${sub.name}" onchange="updateSubName(${cat.id},${si},this.value)"></td>
        <td style="text-align:center;"><label class="toggle-wrap"><input type="checkbox" ${sub.enabled?'checked':''} onchange="updateSubProp(${cat.id},${si},'enabled',this.checked)"><span class="toggle-slider"></span></label></td>
        <td style="text-align:center;"><label class="toggle-wrap"><input type="checkbox" ${sub.needCustomer?'checked':''} onchange="updateSubProp(${cat.id},${si},'needCustomer',this.checked)"><span class="toggle-slider"></span></label></td>
        <td style="text-align:center;"><label class="toggle-wrap"><input type="checkbox" ${sub.isDev?'checked':''} onchange="updateSubProp(${cat.id},${si},'isDev',this.checked)"><span class="toggle-slider"></span></label></td>
        <td style="text-align:center;"><button class="btn-small danger" onclick="deleteSub(${cat.id},${si})">å‰Šé™¤</button></td>
      </tr>`).join('');
    section.innerHTML=`
      <div class="cat-section-header">
        <span>${cat.emoji}</span><span>${cat.name}</span>
        <button class="btn-small purple" style="margin-left:auto;" onclick="addSubCategoryFor(${cat.id})">ï¼‹ è¿½åŠ </button>
      </div>
      <div class="cat-section-body">
        <table class="master-table" style="min-width:560px;">
          <thead><tr><th>é †åº</th><th>çµµæ–‡å­—</th><th>æ¥­å‹™å†…å®¹å</th><th>æœ‰åŠ¹</th><th>é¡§å®¢é¸æŠ</th><th>é–‹ç™ºãƒ•ãƒ­ãƒ¼</th><th>æ“ä½œ</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    container.appendChild(section);
  });
}
function addSubCategory(){ if(!categoryMaster.length){alert('å…ˆã«æ¥­å‹™ç¨®é¡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');return;} addSubCategoryFor(categoryMaster[0].id); }
function addSubCategoryFor(catId){
  masterIdCounter++;
  const ex=subCategoryMaster.filter(s=>s.catId===catId);
  subCategoryMaster.push({id:masterIdCounter,catId:catId,emoji:'ğŸ“Œ',name:'æ–°è¦æ¥­å‹™å†…å®¹',enabled:true,needCustomer:false,isDev:false,order:ex.length+1});
  renderSubMasterContent();
}
function updateSubName(catId,si,val){ const s=subCategoryMaster.filter(s=>s.catId===catId).sort((a,b)=>a.order-b.order); s[si].name=val; }
function updateSubProp(catId,si,prop,val){ const s=subCategoryMaster.filter(s=>s.catId===catId).sort((a,b)=>a.order-b.order); s[si][prop]=val; }
function deleteSub(catId,si){
  const s=subCategoryMaster.filter(s=>s.catId===catId).sort((a,b)=>a.order-b.order);
  if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ const idx=subCategoryMaster.indexOf(s[si]); subCategoryMaster.splice(idx,1); subCategoryMaster.filter(s=>s.catId===catId).sort((a,b)=>a.order-b.order).forEach((s,j)=>s.order=j+1); renderSubMasterContent(); }
}
function moveSub(catId,si,dir){
  const s=subCategoryMaster.filter(s=>s.catId===catId).sort((a,b)=>a.order-b.order);
  const j=si+dir;
  if(j<0||j>=s.length) return;
  [s[si].order,s[j].order]=[s[j].order,s[si].order];
  renderSubMasterContent();
}
</script>
</body>
</html>
